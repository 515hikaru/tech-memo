---
title: "ミニマムな Makefile 入門: GNU Makeをタスクランナーとして使う"
date: 2020-04-11T16:35:40+09:00
draft: false
tags: ["BuildTool"]
---

GNU Make はとてもシンプルで汎用性の高い、強力なビルドツールです。汎用性が高く導入コストが低いビルドツールはなかなかありません。なので現代でも重宝されています。

古いツールなので、今のプログラマからすると「なぜこんなこともできないの？」と思うようなことができない、といった弱点がないではありません。しかし、それは後方互換性が重視され続けてきた証でもあり、どの場面で導入を決定しても、バージョンアップにおいて後方互換性が崩れることを過度に心配しなくてよいことを意味します。

GNU Make について調べていると、C 言語で書かれたソフトウェアのビルドツールとして書かれている記事が多いですが、決して GNU Make 自体は C 言語に特化したツールではありません。そこで今回は Python のスクリプトの依存関係を GNU Make を用いて管理するサンプルを解説しようと思います。

考えられる実用例としては下記のようなものが考えられます。

- 機械学習などにおけるデータの前処理（前処理済み CSV などの書き出し）
- バッチ処理の簡易的なジョブ化
- Web アプリケーション開発におけるタスク定義（npm-scripts のようなもの）

特にデータの前処理のように成果物どうしの依存関係や、1 回の実行で多大な時間を消費するタスクについては役に立つと思います。データやスクリプトの依存関係を考慮し、タイムスタンプからタスク実行の要／不要を判断してくれるのは大変便利です。

以降、GNU Make を単に Make と書きます。 BSD Make もありますが、筆者は利用したことがなく、どのように違うのかも寡聞にして知りません。

## Makefile についてのミニマムな知識

Makefile について知っておくべき文法は、極論すると下記の 2 行に集約されます。

```makefile
${成果物へのパス}: ${依存ファイルへのパス}
	${実行コマンド}
```

コマンドの前の空白は**タブ文字のみ**です。**スペースは不可**です。

例えば main.py を実行したときに output.csv を出力する場合は下記のように記述します。

```makefile
output.csv: main.py
	python3 main.py
```

## 依存関係の考慮

Make はジョブが依存しているファイルのタイムスタンプを見ることで当該ジョブが更新が必要なジョブかどうかをチェックします。実際にやってみましょう。

まずは main.py を次のように記述します。

```python
def main():
    with open("output.csv", "w") as _:
        pass

if __mame__ == '__main__':
    main()
```

このスクリプトは空ファイルを作ります。この状態で `make` を実行してみましょう。

```
$ make
$ ls
```

これで output.csv が作成されたと思います。ここで、もう 1 回 `make` をしてみましょう。

## いくつかの慣習

## cookiecutter-data-science の Makefile のサンプル
